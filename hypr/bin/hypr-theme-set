#!/bin/bash

# Function to send notifications
notify() {
    notify-send "Hypr Theme" "$1" -t 3000
}

# hypr-theme-set: Set a theme, specified by its name.
# Usage: hypr-theme-set <theme-name>

if [[ -z "$1" || "$1" == "CNCLD" ]]; then
    notify "Theme selection cancelled."
    exit 1
fi

THEME_NAME_FORMATTED="$1"
THEME_NAME=$(echo "$THEME_NAME_FORMATTED" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
THEMES_DIR="$HOME/.config/hypr/themes"
THEME_PATH="$THEMES_DIR/$THEME_NAME"
CURRENT_THEME_DIR="$HOME/.config/hypr/theme"

# Check if the theme entered exists
if [[ ! -d "$THEME_PATH" ]]; then
    notify "Error: Theme '$THEME_NAME_FORMATTED' does not exist."
    exit 2
fi

# Update theme symlinks
notify "Setting theme to $THEME_NAME_FORMATTED..."
mkdir -p "$CURRENT_THEME_DIR"
find "$CURRENT_THEME_DIR" -mindepth 1 -delete
for file in "$THEME_PATH"/*; do
    ln -s "$file" "$CURRENT_THEME_DIR"
done

# --- Apply theme to various applications ---

# Change GNOME settings
if [[ -f "$CURRENT_THEME_DIR/light.mode" ]]; then
    gsettings set org.gnome.desktop.interface color-scheme "prefer-light"
    gsettings set org.gnome.desktop.interface gtk-theme "Adwaita"
else
    gsettings set org.gnome.desktop.interface color-scheme "prefer-dark"
    gsettings set org.gnome.desktop.interface gtk-theme "Adwaita-dark"
fi

if [[ -f "$CURRENT_THEME_DIR/icons.theme" ]]; then
    gsettings set org.gnome.desktop.interface icon-theme "$(<"$CURRENT_THEME_DIR/icons.theme")"
else
    gsettings set org.gnome.desktop.interface icon-theme "Yaru-blue"
fi

# Change Chromium colors
if command -v chromium &>/dev/null; then
    if [[ -f "$CURRENT_THEME_DIR/light.mode" ]]; then
        chromium --no-startup-window --set-color-scheme="light" &>/dev/null
    else
        chromium --no-startup-window --set-color-scheme="dark" &>/dev/null
    fi

    if [[ -f "$CURRENT_THEME_DIR/chromium.theme" ]]; then
        chromium --no-startup-window --set-theme-color="$(<"$CURRENT_THEME_DIR/chromium.theme")" &>/dev/null
    else
        chromium --no-startup-window --set-theme-color="28,32,39" &>/dev/null
    fi
fi

# Trigger alacritty config reload
touch "$HOME/.config/alacritty/alacritty.toml"

# Restart components to apply new theme
pkill -SIGUSR2 btop || true
hypr-restart-waybar || notify "Failed to restart Waybar."
hypr-restart-swayosd || notify "Failed to restart SwayOSD."
hypr-restart-walker || notify "Failed to restart Walker."
makoctl reload || notify "Failed to reload Mako."
hyprctl reload || notify "Failed to reload Hyprland."

# Set new background
hypr-theme-bg-next

notify "Theme '$THEME_NAME_FORMATTED' applied successfully."
