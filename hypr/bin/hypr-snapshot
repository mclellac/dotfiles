#!/bin/bash

set -e

source "$(dirname "$0")/hypr-utils"
check_deps snapper hypr-version awk sudo limine-snapper-restore

COMMAND="$1"

if [[ -z $COMMAND ]]; then
  echo "Usage: hypr-snapshot <create|restore>" >&2
  exit 1
fi

case "$COMMAND" in
create)
  DESC="$(hypr-version)"

  echo -e "\e[32mCreate system snapshot\e[0m"
  
  # Get existing snapper config names from CSV output
  mapfile -t CONFIGS < <(sudo snapper --csvout list-configs | awk -F, 'NR>1 {print $1}')

  for config in "${CONFIGS[@]}"; do
    sudo snapper -c "$config" create -c number -d "$DESC"
  done
  echo
  echo "System snapshot created. Description: $DESC"
  ;;
restore)
  sudo limine-snapper-restore
  ;;
esac
